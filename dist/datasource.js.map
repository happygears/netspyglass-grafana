{"version":3,"sources":["../src/datasource.js"],"names":["_","dateMath","NetSpyGlassDatasource","result","map","data","d","i","text","value","tagMatches","tags","idx","length","tm","tt","tagOperation","tagFacet","tagWord","push","join","instanceSettings","$q","backendSrv","templateSrv","type","url","name","networkId","jsonData","accessToken","useToken","undefined","endpointsBase","endpoints","category","variable","query","test","blankDropDownElement","blankValues","alias","device","component","description","sortByEl","selector","aggregator","limit","group","interval","tagData","format","columns","unique","refId","clearString","endpoint","method","datasourceRequest","headers","options","aliases","targets","targetDlg","response","_apiCall","buildQueryFronNsgQlStirng","then","console","log","forEach","item","sort","nsgql","series","aliasWithVarsReplaced","replace","regex","match","g1","g2","tag","status","message","title","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","interpolated","scopedVars","err","reject","buildQueryFromText","target","JSON","stringify","mapToTextText","mapToTextValue","buildQuery","index","clonedOptions","jQuery","extend","facet","queryObject","updatedTarget","replaceTemplateVars","field","replaced","startsWith","temp","key","filter","isBlankTagMatch","t","buildQueryFromQueryDialogData","parse","templateSrvParameters","hide","removeBlanks","transformTagMatch","id","from","getTimeForApiCall","until","to","groupByTime","getTime","date","roundUp","isString","parts","exec","amount","parseInt","unit","valueOf","timeFilter","getTimeFilter","queriesList","customNsgqlQuery","indexOf","toFixed"],"mappings":";;;;;;;;;;;;;;;AAgBOA,a;;AACKC,oB;;;;;;;;;;;;;;;;;;;;;6CAECC,qB;;;mDAEaC,M,EAAQ;AAC1B,+BAAOH,EAAEI,GAAF,CAAMD,OAAOE,IAAb,EAAmB,UAACC,CAAD,EAAIC,CAAJ,EAAU;AAChC,mCAAO,EAACC,MAAMF,CAAP,EAAUG,OAAOF,CAAjB,EAAP;AACH,yBAFM,CAAP;AAGH;;;kDAEoBJ,M,EAAQ;AACzB,+BAAOH,EAAEI,GAAF,CAAMD,OAAOE,IAAb,EAAmB,UAACC,CAAD,EAAIC,CAAJ,EAAU;AAChC,mCAAO,EAACC,MAAMF,CAAP,EAAUG,OAAOH,CAAjB,EAAP;AACH,yBAFM,CAAP;AAGH;;;sDAYwBI,U,EAAY;AACjC,4BAAIC,OAAO,EAAX;AACA,4BAAIC,GAAJ;AACA,6BAAKA,MAAM,CAAX,EAAcA,MAAMF,WAAWG,MAA/B,EAAuCD,KAAvC,EAA8C;AAC1C,gCAAIE,KAAKJ,WAAWE,GAAX,CAAT;AACA,gCAAIG,KAAK,CAAED,GAAGE,YAAH,KAAoB,IAArB,GAA6B,GAA7B,GAAmC,EAApC,IAA0CF,GAAGG,QAA7C,IAA0DH,GAAGI,OAAH,KAAe,EAAhB,GAAuB,MAAMJ,GAAGI,OAAhC,GAA2C,EAApG,CAAT;AACAP,iCAAKQ,IAAL,CAAUJ,EAAV;AACH;AACD,+BAAOJ,KAAKS,IAAL,CAAU,GAAV,CAAP;AACH;;;AAED,+CAAYC,gBAAZ,EAA8BC,EAA9B,EAAkCC,UAAlC,EAA8CC,WAA9C,EAA2D;AAAA;;AACvD,yBAAKC,IAAL,GAAYJ,iBAAiBI,IAA7B;AACA,yBAAKC,GAAL,GAAWL,iBAAiBK,GAA5B;AACA,yBAAKC,IAAL,GAAYN,iBAAiBM,IAA7B;AACA,yBAAKL,EAAL,GAAUA,EAAV;AACA,yBAAKC,UAAL,GAAkBA,UAAlB;AACA,yBAAKC,WAAL,GAAmBA,WAAnB;AACA,yBAAKI,SAAL,GAAiBP,iBAAiBQ,QAAjB,CAA0BD,SAA1B,IAAuC,CAAxD;AACA,yBAAKE,WAAL,GAAoBT,iBAAiBQ,QAAjB,CAA0BE,QAA1B,KAAuC,KAAvC,IAAgDV,iBAAiBQ,QAAjB,CAA0BC,WAA1B,KAA0CE,SAA1F,IAAuGX,iBAAiBQ,QAAjB,CAA0BC,WAA1B,KAA0C,EAAlJ,GAAwJ,mBAAmBT,iBAAiBQ,QAAjB,CAA0BC,WAArM,GAAmN,EAAtO;AACA,yBAAKG,aAAL,GAAqB,mBAAmB,KAAKL,SAA7C;AACA,yBAAKM,SAAL,GAAiB,EAAjB;AACA,yBAAKA,SAAL,CAAeC,QAAf,GAA0B,KAAKF,aAAL,GAAqB,cAArB,GAAsC,KAAKH,WAArE;AACA,yBAAKI,SAAL,CAAeE,QAAf,GAA0B,KAAKH,aAAL,GAAqB,aAA/C;AACA,yBAAKC,SAAL,CAAeG,KAAf,GAAuB,KAAKJ,aAAL,GAAqB,QAArB,GAAgC,KAAKH,WAA5D;AACA,yBAAKI,SAAL,CAAeI,IAAf,GAAsB,kBAAkB,KAAKV,SAAvB,GAAmC,QAAnC,GAA8C,KAAKE,WAAzE;;AAEA,yBAAKS,oBAAL,GAA4B,KAA5B;;AAEA,yBAAKC,WAAL,GAAmB,EAAnB;AACA,yBAAKA,WAAL,CAAiBC,KAAjB,GAAyB,EAAzB;AACA,yBAAKD,WAAL,CAAiBJ,QAAjB,GAA4B,iBAA5B;AACA,yBAAKI,WAAL,CAAiBE,MAAjB,GAA0B,eAA1B;AACA,yBAAKF,WAAL,CAAiBG,SAAjB,GAA6B,kBAA7B;AACA,yBAAKH,WAAL,CAAiBI,WAAjB,GAA+B,EAA/B;AACA,yBAAKJ,WAAL,CAAiBK,QAAjB,GAA4B,gBAA5B;AACA,yBAAKL,WAAL,CAAiBM,QAAjB,GAA4B,MAA5B;AACA,yBAAKN,WAAL,CAAiBO,UAAjB,GAA8B,MAA9B;AACA,yBAAKP,WAAL,CAAiBQ,KAAjB,GAAyB,cAAzB;AACA,yBAAKR,WAAL,CAAiBS,KAAjB,GAAyB,cAAzB;AACA,yBAAKT,WAAL,CAAiBvB,QAAjB,GAA4B,KAAKsB,oBAAjC;AACA,yBAAKC,WAAL,CAAiBtB,OAAjB,GAA2B,KAAKqB,oBAAhC;AACA,yBAAKC,WAAL,CAAiBU,QAAjB,GAA4B,iBAA5B;AACA,yBAAKV,WAAL,CAAiBW,OAAjB,GAA2B,EAA3B;AACA,yBAAKX,WAAL,CAAiB7B,IAAjB,GAAwB,EAAxB;AACA,yBAAK6B,WAAL,CAAiBY,MAAjB,GAA0B,EAA1B;AACA,yBAAKZ,WAAL,CAAiBa,OAAjB,GAA2B,EAA3B;AACA,yBAAKb,WAAL,CAAiBc,MAAjB,GAA0B,EAA1B;AACA,yBAAKd,WAAL,CAAiBe,KAAjB,GAAyB,EAAzB;;AAEA,yBAAKC,WAAL,GAAmB,uBAAnB;AACH;;AAED;;;;;;;;;;;;;6CASSC,Q,EAAUC,M,EAAQrB,K,EAAO;AAC9B,+BAAO,KAAKd,UAAL,CAAgBoC,iBAAhB,CAAkC;AACrCjC,iCAAK,KAAKA,GAAL,GAAW+B,QADqB;AAErCpD,kCAAMgC,KAF+B;AAGrCqB,oCAAQA,MAH6B;AAIrCE,qCAAS,EAAC,gBAAgB,kBAAjB;AAJ4B,yBAAlC,CAAP;AAMH;;;0CAQKC,O,EAAS;AACX,4BAAItD,UAAJ;AAAA,4BACIuD,UAAU,EADd;;AAGA,6BAAK,IAAIvD,KAAI,CAAb,EAAgBA,KAAIsD,QAAQE,OAAR,CAAgBlD,MAApC,EAA4CN,IAA5C,EAAiD;AAC7C,gCAAIyD,YAAYH,QAAQE,OAAR,CAAgBxD,EAAhB,CAAhB;AACAuD,oCAAQE,UAAUT,KAAlB,IAA2BS,UAAUvB,KAArC;AACH;;AAED,4BAAIwB,WAAW,KAAKC,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EAA4C;AACvD0B,qCAAS,KAAKI,yBAAL,CAA+BN,OAA/B;AAD8C,yBAA5C,CAAf;;AAIA,+BAAOI,SAASG,IAAT,CAAe,oBAAY;AAC9B,gCAAIP,QAAQT,MAAR,KAAmB,OAAnB,IAA8Ba,SAAS5D,IAA3C,EAAkD;AAC9C,oCAAIA,OAAO4D,SAAS5D,IAApB;;AAEAgE,wCAAQC,GAAR,CAAYjE,IAAZ;;AAEAA,qCAAKkE,OAAL,CAAc,UAACC,IAAD,EAAU;AACpBH,4CAAQC,GAAR,CAAYE,KAAKnB,OAAL,CAAaoB,IAAzB;AACH,iCAFD;AAGH;;AAED,mCAAOR,QAAP;AACH,yBAZM,CAAP;AAaH;;;iDAEYS,K,EAAOtB,M,EAAQ;AACxB,+BAAO,KAAKc,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EACH,EAAC,WAAU,CAAC;AACR,yCAASqC,KADD;AAER,0CAAUtB;AAFF,6BAAD,CAAX,EADG,EAKLgB,IALK,CAKC,oBAAY;AAChB,gCAAI/D,OAAO4D,SAAS5D,IAApB;AACA,gCAAI,CAACA,IAAL,EAAW,OAAO4D,QAAP;;AAEX,mCAAO5D,IAAP;AACH,yBAVM,CAAP;AAWH;;;kDAKasE,M,EAAQlC,K,EAAO;AACzB;AACA,4BAAImC,wBAAwB,KAAKpD,WAAL,CAAiBqD,OAAjB,CAAyBpC,KAAzB,CAA5B;;AAEA,4BAAIqC,QAAQ,2BAAZ;AACA,+BAAOF,sBAAsBC,OAAtB,CAA8BC,KAA9B,EAAqC,UAASC,KAAT,EAAgBC,EAAhB,EAAoBC,EAApB,EAAwB;AAChE,gCAAIhC,QAAQ+B,MAAMC,EAAlB;;AAEA,gCAAIhC,UAAU,GAAV,IAAiBA,UAAU,aAA3B,IAA4CA,UAAU,UAA1D,EAAsE;AAAE,uCAAO0B,OAAOvC,QAAd;AAAyB;AACjG,gCAAIa,UAAU,QAAd,EAAwB,OAAO0B,OAAOjC,MAAd;AACxB,gCAAIO,UAAU,WAAd,EAA2B,OAAO0B,OAAOhC,SAAd;AAC3B,gCAAIM,UAAU,aAAd,EAA6B,OAAO0B,OAAO/B,WAAd;;AAE7B;AACA,gCAAI,CAAC+B,OAAOhE,IAAZ,EAAkB;AAAE,uCAAOoE,KAAP;AAAe;;AAEnC;AACA,gCAAIG,MAAMP,OAAOhE,IAAP,CAAYsC,KAAZ,CAAV;AACA,gCAAI,OAAOiC,GAAP,KAAe,WAAnB,EAAgC,OAAOH,KAAP;AAChC,mCAAOG,GAAP;AACH,yBAfM,CAAP;AAgBH;;;qDAIgB;AACb,4BAAIzB,WAAW,KAAKvB,SAAL,CAAeI,IAA9B;AACA,+BAAO,KAAKf,UAAL,CAAgBoC,iBAAhB,CAAkC;AACrCjC,iCAAK,KAAKA,GAAL,GAAW+B,QADqB;AAErCC,oCAAQ;AAF6B,yBAAlC,EAGJU,IAHI,CAGC,oBAAY;AAChB,gCAAIH,SAASkB,MAAT,KAAoB,GAAxB,EAA6B;AACzB,uCAAO,EAACA,QAAQ,SAAT,EAAoBC,SAAS,wBAA7B,EAAuDC,OAAO,SAA9D,EAAP;AACH;AACJ,yBAPM,CAAP;AAQH;;;oDAEexB,O,EAAS;AACrB,4BAAIxB,QAAQ,KAAKb,WAAL,CAAiBqD,OAAjB,CAAyBhB,QAAQyB,UAAR,CAAmBjD,KAA5C,EAAmD,EAAnD,EAAuD,MAAvD,CAAZ;AACA,4BAAIkD,kBAAkB;AAClBC,mCAAO3B,QAAQ2B,KADG;AAElBF,wCAAY;AACR3D,sCAAMkC,QAAQyB,UAAR,CAAmB3D,IADjB;AAER8D,4CAAY5B,QAAQyB,UAAR,CAAmBG,UAFvB;AAGRC,wCAAQ7B,QAAQyB,UAAR,CAAmBI,MAHnB;AAIRC,2CAAW9B,QAAQyB,UAAR,CAAmBK,SAJtB;AAKRtD,uCAAOA;AALC,6BAFM;AASlBuD,sCAAU/B,QAAQ+B;AATA,yBAAtB;AAWA,+BAAO,KAAKrE,UAAL,CAAgBoC,iBAAhB,CAAkC;AACrCjC,iCAAK,KAAKA,GAAL,GAAW,cAAX,GAA4B,KAAKI,WADD;AAErC4B,oCAAQ,MAF6B;AAGrCrD,kCAAMkF;AAH+B,yBAAlC,EAIJnB,IAJI,CAIC,kBAAU;AACd,mCAAOjE,OAAOE,IAAd;AACH,yBANM,CAAP;AAOH;;;oDA6BegC,K,EAAO;AACnB,4BAAIwD,YAAJ;AACA,4BAAI;AACAA,2CAAe,KAAKrE,WAAL,CAAiBqD,OAAjB,CAAyBxC,KAAzB,EAAgCA,MAAMyD,UAAtC,CAAf;AACH,yBAFD,CAEE,OAAOC,GAAP,EAAY;AACV,mCAAO,KAAKzE,EAAL,CAAQ0E,MAAR,CAAeD,GAAf,CAAP;AACH;AACD,4BAAI1F,OAAO,KAAK4F,kBAAL,CAAwBJ,YAAxB,CAAX;AACA,4BAAIK,SAAS7F,KAAK0D,OAAL,CAAa,CAAb,CAAb;AACAmC,+BAAO9C,MAAP,GAAgB,MAAhB;AACA,+BAAO,KAAKc,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EAA4C8D,KAAKC,SAAL,CAAe/F,IAAf,CAA5C,EAAkE+D,IAAlE,CAAuElE,sBAAsBmG,aAA7F,CAAP;AACH;;;0DAEqB;AAClB,+BAAO,KAAKnC,QAAL,CAAc,KAAKhC,SAAL,CAAeC,QAA7B,EAAuC,MAAvC,EAA+C,EAA/C,EAAmDiC,IAAnD,CAAwDlE,sBAAsBoG,cAA9E,CAAP;AACH;;;uDAEkBzC,O,EAAS;AACxB,4BAAIJ,WAAW,KAAKvB,SAAL,CAAeE,QAAf,GAA0ByB,QAAQ1B,QAAlC,GAA6C,KAAKL,WAAjE;AACA,+BAAO,KAAKoC,QAAL,CAAcT,QAAd,EAAwB,MAAxB,EAAgC,EAAhC,EAAoCW,IAApC,CAAyClE,sBAAsBoG,cAA/D,CAAP;AACH;;;gDAEWzC,O,EAAS;AACjB,4BAAIxD,OAAO,KAAKkG,UAAL,CAAgB1C,OAAhB,CAAX;AACA,4BAAIqC,SAAS7F,KAAK0D,OAAL,CAAa,CAAb,CAAb;AACAmC,+BAAOxD,MAAP,GAAgB,EAAhB,CAHiB,CAGI;AACrBwD,+BAAOvD,SAAP,GAAmB,EAAnB;AACAuD,+BAAO7C,OAAP,GAAiB,QAAjB;AACA6C,+BAAO5C,MAAP,GAAgB,QAAhB;AACA4C,+BAAOrD,QAAP,GAAkB,kBAAlB;AACAqD,+BAAO9C,MAAP,GAAgB,MAAhB;AACA8C,+BAAOlD,KAAP,GAAe,CAAC,CAAhB;AACA,4BAAIX,QAAQ8D,KAAKC,SAAL,CAAe/F,IAAf,CAAZ;AACAgC,gCAAQ,KAAKb,WAAL,CAAiBqD,OAAjB,CAAyBxC,KAAzB,EAAgCwB,QAAQiC,UAAxC,CAAR;AACA,+BAAO,KAAK5B,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EAA4CA,KAA5C,EAAmD+B,IAAnD,CAAwDlE,sBAAsBmG,aAA9E,CAAP;AACH;;;mDAEcxC,O,EAAS;AACpB,4BAAIxD,OAAO,KAAKkG,UAAL,CAAgB1C,OAAhB,CAAX;AACA,4BAAIqC,SAAS7F,KAAK0D,OAAL,CAAa,CAAb,CAAb;AACAmC,+BAAOvD,SAAP,GAAmB,EAAnB,CAHoB,CAGI;AACxBuD,+BAAO7C,OAAP,GAAiB,WAAjB;AACA6C,+BAAO5C,MAAP,GAAgB,WAAhB;AACA4C,+BAAOrD,QAAP,GAAkB,qBAAlB;AACAqD,+BAAO9C,MAAP,GAAgB,MAAhB;AACA8C,+BAAOlD,KAAP,GAAe,CAAC,CAAhB;AACA,4BAAIX,QAAQ8D,KAAKC,SAAL,CAAe/F,IAAf,CAAZ;AACAgC,gCAAQ,KAAKb,WAAL,CAAiBqD,OAAjB,CAAyBxC,KAAzB,EAAgCwB,QAAQiC,UAAxC,CAAR;AACA,+BAAO,KAAK5B,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EAA4CA,KAA5C,EAAmD+B,IAAnD,CAAwDlE,sBAAsBmG,aAA9E,CAAP;AACH;;;kDAEaxC,O,EAAS2C,K,EAAO;AAC1B,4BAAIC,gBAAgBC,OAAOC,MAAP,CAAc,IAAd,EAAoB,EAApB,EAAwB9C,OAAxB,CAApB;AACA4C,sCAActD,OAAd,CAAsBqD,KAAtB,EAA6BvF,QAA7B,GAAwC,EAAxC;AACAwF,sCAActD,OAAd,CAAsBqD,KAAtB,EAA6BtF,OAA7B,GAAuC,EAAvC;AACA,4BAAIb,OAAO,KAAKkG,UAAL,CAAgBE,aAAhB,CAAX;AACA,4BAAIP,SAAS7F,KAAK0D,OAAL,CAAa,CAAb,CAAb;AACAmC,+BAAO7C,OAAP,GAAiB,UAAjB;AACA6C,+BAAO5C,MAAP,GAAgB,UAAhB;AACA4C,+BAAOrD,QAAP,GAAkB,oBAAlB;AACAqD,+BAAO9C,MAAP,GAAgB,MAAhB;AACA8C,+BAAOlD,KAAP,GAAe,CAAC,CAAhB;AACA,4BAAIX,QAAQ8D,KAAKC,SAAL,CAAe/F,IAAf,CAAZ;AACAgC,gCAAQ,KAAKb,WAAL,CAAiBqD,OAAjB,CAAyBxC,KAAzB,EAAgCwB,QAAQiC,UAAxC,CAAR;AACA,+BAAO,KAAK5B,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EAA4CA,KAA5C,EAAmD+B,IAAnD,CAAwDlE,sBAAsBmG,aAA9E,CAAP;AACH;;;sDAEiBxC,O,EAAS2C,K,EAAO;AAC9B,4BAAIC,gBAAgBC,OAAOC,MAAP,CAAc,IAAd,EAAoB,EAApB,EAAwB9C,OAAxB,CAApB;AACA,4BAAI+C,QAAQH,cAActD,OAAd,CAAsBqD,KAAtB,EAA6BvF,QAAzC;AACAwF,sCAActD,OAAd,CAAsBqD,KAAtB,EAA6BtF,OAA7B,GAAuC,EAAvC;AACA,4BAAIb,OAAO,KAAKkG,UAAL,CAAgBE,aAAhB,CAAX;AACA,4BAAIP,SAAS7F,KAAK0D,OAAL,CAAa,CAAb,CAAb;AACAmC,+BAAO7C,OAAP,GAAiBuD,KAAjB;AACAV,+BAAO5C,MAAP,GAAgBsD,KAAhB;AACAV,+BAAOrD,QAAP,GAAkB+D,QAAQ,YAA1B;AACAV,+BAAO9C,MAAP,GAAgB,MAAhB;AACA8C,+BAAOlD,KAAP,GAAe,CAAC,CAAhB;AACA,4BAAIX,QAAQ8D,KAAKC,SAAL,CAAe/F,IAAf,CAAZ;AACAgC,gCAAQ,KAAKb,WAAL,CAAiBqD,OAAjB,CAAyBxC,KAAzB,EAAgCwB,QAAQiC,UAAxC,CAAR;AACA,+BAAO,KAAK5B,QAAL,CAAc,KAAKhC,SAAL,CAAeG,KAA7B,EAAoC,MAApC,EAA4CA,KAA5C,EAAmD+B,IAAnD,CAAwDlE,sBAAsBmG,aAA9E,CAAP;AACH;;;0DAaqBQ,W,EAAa;AAAA;;AAC/BA,oCAAY9C,OAAZ,GAAsB/D,EAAEI,GAAF,CAAMyG,YAAY9C,OAAlB,EAA2B,kBAAU;AACvD,gCAAI+C,gBAAgBJ,OAAOC,MAAP,CAAc,IAAd,EAAoB,EAApB,EAAwBT,MAAxB,CAApB;AACAY,0CAAc3E,QAAd,GAAyB,MAAK4E,mBAAL,CAAyBD,cAAc3E,QAAvC,CAAzB;AACA2E,0CAAcpE,MAAd,GAAuB,MAAKqE,mBAAL,CAAyBD,cAAcpE,MAAvC,CAAvB;AACAoE,0CAAcnE,SAAd,GAA0B,MAAKoE,mBAAL,CAAyBD,cAAcnE,SAAvC,CAA1B;AACAmE,0CAAclE,WAAd,GAA4B,MAAKmE,mBAAL,CAAyBD,cAAclE,WAAvC,CAA5B;AACAkE,0CAAc9D,KAAd,GAAuB8D,cAAc9D,KAAd,KAAwB,EAAzB,GAA+B,CAAC,CAAhC,GAAoC8D,cAAc9D,KAAxE;AACA;AACA,mCAAO8D,aAAP;AACH,yBATqB,CAAtB;AAUA,+BAAOD,WAAP;AACH;;;wDAEmBG,K,EAAO;AACvB,4BAAI,OAAOA,KAAP,KAAiB,WAArB,EAAkC,OAAOA,KAAP;AAClC,4BAAIC,WAAW,KAAKzF,WAAL,CAAiBqD,OAAjB,CAAyBmC,KAAzB,CAAf;AACA;AACA,4BAAIA,MAAME,UAAN,CAAiB,GAAjB,KAAyBD,SAASC,UAAT,CAAoB,GAApB,CAA7B,EAAuDD,WAAW,EAAX;AACvD,+BAAOA,QAAP;AACH;;;iDAEYzC,I,EAAM;AAAA;;AACf,4BAAI2C,OAAO,EAAX;AACA,6BAAK,IAAIC,GAAT,IAAgB5C,IAAhB,EAAsB;AAClB,gCAAI,EAAE4C,OAAO,KAAK5E,WAAd,CAAJ,EAAgC;AAC5B;AACH;AACD,gCAAI,OAAOgC,KAAK4C,GAAL,CAAP,IAAoB,WAApB,IAAmC5C,KAAK4C,GAAL,KAAa,KAAK5D,WAArD,IAAoEgB,KAAK4C,GAAL,KAAa,KAAK5E,WAAL,CAAiB4E,GAAjB,CAArF,EAA4G;AACxG;AACH;AACD,gCAAIA,OAAO,UAAP,IAAqBA,OAAO,SAAhC,EAA2C;AACvC;AACH;AACD,gCAAIA,OAAO,SAAX,EAAsB;AAClBD,qCAAKC,GAAL,IAAY5C,KAAK4C,GAAL,EAAUC,MAAV,CAAiB;AAAA,2CAAK,CAAC,OAAKC,eAAL,CAAqBC,CAArB,CAAN;AAAA,iCAAjB,CAAZ;AACH,6BAFD,MAEO;AACHJ,qCAAKC,GAAL,IAAY5C,KAAK4C,GAAL,CAAZ;AACH;AACJ;AACD,+BAAOD,IAAP;AACH;;;oDAEerG,E,EAAI;AAChB,4BAAIA,GAAGG,QAAH,KAAgB,EAAhB,IAAsBH,GAAGG,QAAH,KAAgB,KAAKsB,oBAA/C,EAAqE,OAAO,IAAP;AACrE,+BAAO,CAAC,EAAEzB,GAAGI,OAAH,KAAe,EAAf,IAAqBJ,GAAGI,OAAH,KAAe,KAAKqB,oBAA3C,CAAR;AACH;;;+CAMUsB,O,EAAS;AAChB,4BAAIgD,cAAc;AACd9C,qCAAS,CAAEF,OAAF;AADK,yBAAlB;AAGA,+BAAO,KAAK2D,6BAAL,CAAmCX,WAAnC,CAAP;AACH;;;uDAMkBhD,O,EAAS;AACxB,4BAAIgD,cAAc;AACd9C,qCAAS,CAAEoC,KAAKsB,KAAL,CAAW5D,OAAX,CAAF;AADK,yBAAlB;AAGA,+BAAO,KAAK2D,6BAAL,CAAmCX,WAAnC,CAAP;AACH;;;kEAM6BxE,K,EAAO;AACjC,6BAAKqF,qBAAL,CAA2BrF,KAA3B;AACA;AACA;AACAA,8BAAM0B,OAAN,GAAgB1B,MAAM0B,OAAN,CAAcsD,MAAd,CAAqB;AAAA,mCAAK,CAACE,EAAEI,IAAR;AAAA,yBAArB,CAAhB;AACA,4BAAId,cAAc;AACd9C,qCAAS;AADK,yBAAlB;AAGA,4BAAIyC,KAAJ;AACA,6BAAKA,QAAQnE,MAAM0B,OAAN,CAAclD,MAAd,GAAuB,CAApC,EAAuC2F,SAAS,CAAhD,EAAmD,EAAEA,KAArD,EAA4D;AACxD,gCAAIN,SAAS,KAAK0B,YAAL,CAAkBvF,MAAM0B,OAAN,CAAcyC,KAAd,CAAlB,CAAb;AACA,gCAAI,OAAON,OAAO/C,OAAd,KAA0B,WAA9B,EAA2C;AACvC+C,uCAAOvF,IAAP,GAAcT,sBAAsB2H,iBAAtB,CAAwC3B,OAAO/C,OAA/C,CAAd;AACH;AACD,mCAAO+C,OAAO/C,OAAd;AACA,mCAAO+C,OAAOzD,KAAd;AACAyD,mCAAO4B,EAAP,GAAY5B,OAAO3C,KAAnB;AACA,mCAAO2C,OAAO3C,KAAd;AACAsD,wCAAY9C,OAAZ,CAAoB5C,IAApB,CAAyB+E,MAAzB;AACH;AACD,4BAAI,OAAO7D,MAAMuD,QAAb,IAAyB,WAA7B,EAA0C;AACtC;AACA;AACAiB,wCAAYkB,IAAZ,GAAmB7H,sBAAsB8H,iBAAtB,CAAwC3F,MAAMuD,QAAN,CAAemC,IAAvD,EAA6D,KAA7D,CAAnB;AACAlB,wCAAYoB,KAAZ,GAAoB/H,sBAAsB8H,iBAAtB,CAAwC3F,MAAMuD,QAAN,CAAesC,EAAvD,EAA2D,IAA3D,CAApB;AACArB,wCAAYsB,WAAZ,GAA0B9F,MAAMa,QAAhC;AACH;AACD;AACA,+BAAO2D,WAAP;AACH;;;kDAqBahD,O,EAAS;AACnB,4BAAIkE,OAAO,KAAKK,OAAL,CAAavE,QAAQ+B,QAAR,CAAiBmC,IAA9B,EAAoC,KAApC,CAAX;AACA,4BAAIE,QAAQ,KAAKG,OAAL,CAAavE,QAAQ+B,QAAR,CAAiBsC,EAA9B,EAAkC,IAAlC,CAAZ;;AAEA,iDAAuBH,IAAvB,aAAmCE,KAAnC;AACH;;;4CAEOI,I,EAAMC,O,EAAS;AACnB,4BAAItI,EAAEuI,QAAF,CAAWF,IAAX,CAAJ,EAAsB;AAClB,gCAAIA,SAAS,KAAb,EAAoB;;AAEpB,gCAAIG,QAAQ,yBAAyBC,IAAzB,CAA8BJ,IAA9B,CAAZ;AACA,gCAAIG,KAAJ,EAAW;AACP,oCAAIE,SAASC,SAASH,MAAM,CAAN,CAAT,CAAb;AACA,oCAAII,OAAOJ,MAAM,CAAN,CAAX;;AAEA,kDAAeE,MAAf,GAAwBE,IAAxB;AACH;AACDP,mCAAOpI,SAASwH,KAAT,CAAeY,IAAf,EAAqBC,OAArB,CAAP;AACH;;AAED,+BAAOD,KAAKQ,OAAL,KAAiB,IAAxB;AACH;;;8DAEyBhF,O,EAAS;AAC/B,4BAAIiF,aAAa,KAAKC,aAAL,CAAmBlF,OAAnB,CAAjB;AACA,4BAAImF,cAAcnF,QAAQE,OAAR,CAAgB3D,GAAhB,CAAqB,UAAC8F,MAAD,EAAY;AAC/C,gCAAI7D,QAAQ6D,OAAO+C,gBAAnB;;AAEA,gCAAI5G,SAASA,MAAM6G,OAAN,CAAc,cAAd,IAAgC,CAA7C,EAAiD;AAC7C7G,wCAAQrC,EAAE6E,OAAF,CAAUxC,KAAV,EAAiB,cAAjB,EAAiCyG,UAAjC,CAAR;AACH;;AAED,mCAAO;AACH,yCAASzG,KADN;AAEH,0CAAU6D,OAAO9C;AAFd,6BAAP;AAIH,yBAXiB,CAAlB;;AAaA,+BAAO4F,WAAP;AACH;;;sDA3DwBX,I,EAAMC,O,EAAS;AACpC,4BAAItI,EAAEuI,QAAF,CAAWF,IAAX,CAAJ,EAAsB;AAClB,gCAAIA,SAAS,KAAb,EAAoB;AAChB,uCAAO,KAAP;AACH;;AAED,gCAAIG,QAAQ,uBAAuBC,IAAvB,CAA4BJ,IAA5B,CAAZ;AACA,gCAAIG,KAAJ,EAAW;AACP,uCAAOH,IAAP;AACA;AACA;AACA;AACH;AACDA,mCAAOpI,SAASwH,KAAT,CAAeY,IAAf,EAAqBC,OAArB,CAAP;AACH;AACD,+BAAO,CAACD,KAAKQ,OAAL,KAAiB,IAAlB,EAAwBM,OAAxB,CAAgC,CAAhC,IAAqC,GAA5C;AACH","file":"datasource.js","sourcesContent":["/*\n * Copyright (c) 2016.  Happy Gears, Inc\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport _ from \"lodash\";\nimport * as dateMath from './datemath';\n\nexport class NetSpyGlassDatasource {\n\n    static mapToTextValue(result) {\n        return _.map(result.data, (d, i) => {\n            return {text: d, value: i};\n        });\n    }\n\n    static mapToTextText(result) {\n        return _.map(result.data, (d, i) => {\n            return {text: d, value: d};\n        });\n    }\n\n    /**\n     * we get tag matches from the dialog in the form\n     *\n     * [{\"tagFacet\":\"Explicit\",\"tagWord\":\"core\",\"tagOperation\":\"==\"}, {\"tagFacet\":\"Vendor\",\"tagWord\":\"Cisco\",\"tagOperation\":\"<>\"}]\n     *\n     * transform this to\n     *\n     * \"Explicit.core, !Vendor.Cisco\"\n     *\n     */\n    static transformTagMatch(tagMatches) {\n        var tags = [];\n        var idx;\n        for (idx = 0; idx < tagMatches.length; idx++) {\n            var tm = tagMatches[idx];\n            var tt = ((tm.tagOperation === '<>') ? '!' : '') + tm.tagFacet + ((tm.tagWord !== '') ? ('.' + tm.tagWord) : '');\n            tags.push(tt);\n        }\n        return tags.join(',');\n    }\n\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.$q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.networkId = instanceSettings.jsonData.networkId || 1;\n        this.accessToken = (instanceSettings.jsonData.useToken !== false && instanceSettings.jsonData.accessToken !== undefined && instanceSettings.jsonData.accessToken !== '') ? '?access_token=' + instanceSettings.jsonData.accessToken : '';\n        this.endpointsBase = '/v2/query/net/' + this.networkId;\n        this.endpoints = {};\n        this.endpoints.category = this.endpointsBase + '/categories/' + this.accessToken;\n        this.endpoints.variable = this.endpointsBase + '/variables/';\n        this.endpoints.query = this.endpointsBase + '/data/' + this.accessToken;\n        this.endpoints.test = '/v2/ping/net/' + this.networkId + \"/test/\" + this.accessToken;\n\n        this.blankDropDownElement = '---';\n\n        this.blankValues = {};\n        this.blankValues.alias = '';\n        this.blankValues.variable = 'select variable';\n        this.blankValues.device = 'select device';\n        this.blankValues.component = 'select component';\n        this.blankValues.description = '';\n        this.blankValues.sortByEl = 'select sorting';\n        this.blankValues.selector = ' -- ';\n        this.blankValues.aggregator = ' -- ';\n        this.blankValues.limit = 'select limit';\n        this.blankValues.group = 'select group';\n        this.blankValues.tagFacet = this.blankDropDownElement;\n        this.blankValues.tagWord = this.blankDropDownElement;\n        this.blankValues.interval = 'select interval';\n        this.blankValues.tagData = [];\n        this.blankValues.tags = '';\n        this.blankValues.format = '';\n        this.blankValues.columns = '';\n        this.blankValues.unique = '';\n        this.blankValues.refId = '';\n\n        this.clearString = '-- clear selection --';\n    }\n\n    /**\n     * makes actual API call to NetSpyGlass server\n     *\n     * @param endpoint   API call endpoint\n     * @param method     GET or POST\n     * @param query      query object\n     * @returns {*}\n     * @private\n     */\n    _apiCall(endpoint, method, query) {\n        return this.backendSrv.datasourceRequest({\n            url: this.url + endpoint,\n            data: query,\n            method: method,\n            headers: {'Content-Type': 'application/json'}\n        });\n    }\n\n    /**\n     * this function is called when plugin builds a graph\n     *\n     * @param options   an object built from the data entered in the query dialog\n     * @returns {*}\n     */\n    query(options) {\n        let i,\n            aliases = {};\n\n        for (let i = 0; i < options.targets.length; i++) {\n            let targetDlg = options.targets[i];\n            aliases[targetDlg.refId] = targetDlg.alias;\n        }\n\n        var response = this._apiCall(this.endpoints.query, 'POST', {\n            targets: this.buildQueryFronNsgQlStirng(options),\n        });\n\n        return response.then( response => {\n            if( options.format === 'table' && response.data ) {\n                let data = response.data;\n\n                console.log(data);\n\n                data.forEach( (item) => {\n                    console.log(item.columns.sort);\n                })\n            }\n\n            return response;\n        });\n    }\n\n    executeQuery(nsgql, format) {\n        return this._apiCall(this.endpoints.query, 'POST',\n            {'targets':[{\n                'nsgql': nsgql,\n                'format': format\n            }]},\n        ).then( response => {\n            var data = response.data;\n            if (!data) return response;\n\n            return data;\n        })\n    }\n\n    /**\n     * this is where ALIAS BY substitution happens\n     */\n    getSeriesName(series, alias) {\n        // NSGDB-82: we want to be able to use template vars as aliases\n        var aliasWithVarsReplaced = this.templateSrv.replace(alias);\n\n        var regex = /\\$(\\w+)|\\[\\[([\\s\\S]+?)]]/g;\n        return aliasWithVarsReplaced.replace(regex, function(match, g1, g2) {\n            var group = g1 || g2;\n\n            if (group === 'm' || group === 'measurement' || group === 'variable') { return series.variable; }\n            if (group === 'device') return series.device;\n            if (group === 'component') return series.component;\n            if (group === 'description') return series.description;\n\n            // if variable has no tags, we can't substitute tag words\n            if (!series.tags) { return match; }\n\n            // see if it is tag facet\n            var tag = series.tags[group];\n            if (typeof tag === 'undefined') return match;\n            return tag;\n        });\n    };\n\n    // Required\n    // Used for testing datasource in datasource configuration page\n    testDatasource() {\n        var endpoint = this.endpoints.test;\n        return this.backendSrv.datasourceRequest({\n            url: this.url + endpoint,\n            method: 'GET'\n        }).then(response => {\n            if (response.status === 200) {\n                return {status: \"success\", message: \"Data source is working\", title: \"Success\"};\n            }\n        });\n    }\n\n    annotationQuery(options) {\n        var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n        var annotationQuery = {\n            range: options.range,\n            annotation: {\n                name: options.annotation.name,\n                datasource: options.annotation.datasource,\n                enable: options.annotation.enable,\n                iconColor: options.annotation.iconColor,\n                query: query\n            },\n            rangeRaw: options.rangeRaw\n        };\n        return this.backendSrv.datasourceRequest({\n            url: this.url + '/annotations' + this.accessToken,\n            method: 'POST',\n            data: annotationQuery\n        }).then(result => {\n            return result.data;\n        });\n    }\n\n    /**\n     * generic query. Grafana calls this function when it needs to get list of values for a dashboard\n     * template variable.\n     *\n     * User enters query in JSON Format, e.g.\n     *\n     * {\"variable\":\"cpuUtil\",\"columns\":\"device\"}\n     *\n     * User is responsible for setting value of the \"columns\" to what they want to receive back. This can be\n     * \"device\", \"component\" or tag facet\n     *\n     * This function forces request type=table even if user specified something else.\n     *\n     * Server returns data in the following format:\n     *\n     * [ {\n     *   \"columns\" : [ { \"text\" : \"device\" } ],\n     *   \"rows\" : [ [ \"synas1\" ], [ \"ex2200\" ] ],\n     *   \"type\" : \"table\"\n     * } ]\n     *\n     * \"rows\" is a list of lists because normally this query can return multiple columns.\n     * For the purpose of dashboard template we use only the first column if request specified multiple.\n     *\n     * @param query     query object as text string\n     * @returns {Promise.<TResult>}\n     */\n    metricFindQuery(query) {\n        var interpolated;\n        try {\n            interpolated = this.templateSrv.replace(query, query.scopedVars);\n        } catch (err) {\n            return this.$q.reject(err);\n        }\n        var data = this.buildQueryFromText(interpolated);\n        var target = data.targets[0];\n        target.format = 'list';\n        return this._apiCall(this.endpoints.query, 'POST', JSON.stringify(data)).then(NetSpyGlassDatasource.mapToTextText);\n    }\n\n    findCategoriesQuery() {\n        return this._apiCall(this.endpoints.category, 'POST', '').then(NetSpyGlassDatasource.mapToTextValue);\n    }\n\n    findVariablesQuery(options) {\n        var endpoint = this.endpoints.variable + options.category + this.accessToken;\n        return this._apiCall(endpoint, 'POST', '').then(NetSpyGlassDatasource.mapToTextValue);\n    }\n\n    findDevices(options) {\n        var data = this.buildQuery(options);\n        var target = data.targets[0];\n        target.device = '';  // erase to ignore current selection in the dialog\n        target.component = '';\n        target.columns = 'device';\n        target.unique = 'device';\n        target.sortByEl = 'device:ascending';\n        target.format = 'list';\n        target.limit = -1;\n        var query = JSON.stringify(data);\n        query = this.templateSrv.replace(query, options.scopedVars);\n        return this._apiCall(this.endpoints.query, 'POST', query).then(NetSpyGlassDatasource.mapToTextText);\n    }\n\n    findComponents(options) {\n        var data = this.buildQuery(options);\n        var target = data.targets[0];\n        target.component = '';  // erase to ignore current selection in the dialog\n        target.columns = 'component';\n        target.unique = 'component';\n        target.sortByEl = 'component:ascending';\n        target.format = 'list';\n        target.limit = -1;\n        var query = JSON.stringify(data);\n        query = this.templateSrv.replace(query, options.scopedVars);\n        return this._apiCall(this.endpoints.query, 'POST', query).then(NetSpyGlassDatasource.mapToTextText);\n    }\n\n    findTagFacets(options, index) {\n        var clonedOptions = jQuery.extend(true, {}, options);\n        clonedOptions.tagData[index].tagFacet = '';\n        clonedOptions.tagData[index].tagWord = '';\n        var data = this.buildQuery(clonedOptions);\n        var target = data.targets[0];\n        target.columns = 'tagFacet';\n        target.unique = 'tagFacet';\n        target.sortByEl = 'tagFacet:ascending';\n        target.format = 'list';\n        target.limit = -1;\n        var query = JSON.stringify(data);\n        query = this.templateSrv.replace(query, options.scopedVars);\n        return this._apiCall(this.endpoints.query, 'POST', query).then(NetSpyGlassDatasource.mapToTextText);\n    }\n\n    findTagWordsQuery(options, index) {\n        var clonedOptions = jQuery.extend(true, {}, options);\n        var facet = clonedOptions.tagData[index].tagFacet;\n        clonedOptions.tagData[index].tagWord = '';\n        var data = this.buildQuery(clonedOptions);\n        var target = data.targets[0];\n        target.columns = facet;\n        target.unique = facet;\n        target.sortByEl = facet + ':ascending';\n        target.format = 'list';\n        target.limit = -1;\n        var query = JSON.stringify(data);\n        query = this.templateSrv.replace(query, options.scopedVars);\n        return this._apiCall(this.endpoints.query, 'POST', query).then(NetSpyGlassDatasource.mapToTextText);\n    }\n\n    /**\n     * when building graphing query, this function is called with JS object that has at least\n     * attribute 'targets'\n     *\n     * This must include all fields we support in queries, both constructed from the query dialog\n     * (where each field corresponds to the input element in the dialog) and from the input field in\n     * the dashboard templates where user enters query as json.\n     *\n     * field \"description\" is allowed in dashboard template query but does not have corresponding\n     * input field in the query dialog at this time.\n     */\n    templateSrvParameters(queryObject) {\n        queryObject.targets = _.map(queryObject.targets, target => {\n            var updatedTarget = jQuery.extend(true, {}, target);\n            updatedTarget.category = this.replaceTemplateVars(updatedTarget.category);\n            updatedTarget.device = this.replaceTemplateVars(updatedTarget.device);\n            updatedTarget.component = this.replaceTemplateVars(updatedTarget.component);\n            updatedTarget.description = this.replaceTemplateVars(updatedTarget.description);\n            updatedTarget.limit = (updatedTarget.limit === '') ? -1 : updatedTarget.limit;\n            // target.alias = this.replaceTemplateVars(target.alias);\n            return updatedTarget;\n        });\n        return queryObject;\n    }\n\n    replaceTemplateVars(field) {\n        if (typeof field === 'undefined') return field;\n        var replaced = this.templateSrv.replace(field);\n        // if templateSrc could not replace macro with a value, replace it with an empty string\n        if (field.startsWith('$') && replaced.startsWith('$')) replaced = '';\n        return replaced;\n    }\n\n    removeBlanks(item) {\n        var temp = {};\n        for (var key in item) {\n            if (!(key in this.blankValues)) {\n                continue;\n            }\n            if (typeof item[key] == 'undefined' || item[key] == this.clearString || item[key] == this.blankValues[key]) {\n                continue;\n            }\n            if (key == 'tagFacet' || key == 'tagWord') {\n                continue;\n            }\n            if (key == 'tagData') {\n                temp[key] = item[key].filter(t => !this.isBlankTagMatch(t));\n            } else {\n                temp[key] = item[key];\n            }\n        }\n        return temp;\n    }\n\n    isBlankTagMatch(tm) {\n        if (tm.tagFacet === \"\" || tm.tagFacet === this.blankDropDownElement) return true;\n        return !!(tm.tagWord === \"\" || tm.tagWord === this.blankDropDownElement);\n    }\n\n    /**\n     * build query object from an object that represents single query target. This\n     * is called to get items for drop-down lists in the graph or table panel query dialog.\n     */\n    buildQuery(options) {\n        var queryObject = {\n            targets: [ options ]\n        };\n        return this.buildQueryFromQueryDialogData(queryObject);\n    }\n\n    /**\n     * this function is called when we need to build query object from\n     * query entered as text string (e.g. in dashboard template dialog)\n     */\n    buildQueryFromText(options) {\n        var queryObject = {\n            targets: [ JSON.parse(options) ]\n        };\n        return this.buildQueryFromQueryDialogData(queryObject);\n    }\n\n    /**\n     * build query object from query dialog that can have multiple targets. This\n     * is used when plugin builds query for the graph or table panel\n     */\n    buildQueryFromQueryDialogData(query) {\n        this.templateSrvParameters(query);\n        // if we have any \"$word\" left in the query, those are leftover template\n        // variables that did not get expanded because they have no value\n        query.targets = query.targets.filter(t => !t.hide);\n        var queryObject = {\n            targets: []\n        };\n        var index;\n        for (index = query.targets.length - 1; index >= 0; --index) {\n            var target = this.removeBlanks(query.targets[index]);\n            if (typeof target.tagData !== 'undefined') {\n                target.tags = NetSpyGlassDatasource.transformTagMatch(target.tagData);\n            }\n            delete target.tagData;\n            delete target.alias;\n            target.id = target.refId;\n            delete target.refId;\n            queryObject.targets.push(target);\n        }\n        if (typeof query.rangeRaw != 'undefined') {\n            // queryObject.from = this.getTimeFilter(query.rangeRaw.from);\n            // queryObject.until = this.getTimeFilter(query.rangeRaw.to);\n            queryObject.from = NetSpyGlassDatasource.getTimeForApiCall(query.rangeRaw.from, false);\n            queryObject.until = NetSpyGlassDatasource.getTimeForApiCall(query.rangeRaw.to, true);\n            queryObject.groupByTime = query.interval;\n        }\n        // queryObject.scopedVars = '$variable';\n        return queryObject;\n    }\n\n    static getTimeForApiCall(date, roundUp) {\n        if (_.isString(date)) {\n            if (date === 'now') {\n                return 'now';\n            }\n\n            var parts = /^now-(\\d+)([dhmsM])$/.exec(date);\n            if (parts) {\n                return date;\n                // var amount = parseInt(parts[1]);\n                // var unit = parts[2];\n                // return 'now-' + amount + unit;\n            }\n            date = dateMath.parse(date, roundUp);\n        }\n        return (date.valueOf() / 1000).toFixed(0) + 's';\n    }\n\n\n    getTimeFilter(options) {\n        var from = this.getTime(options.rangeRaw.from, false);\n        var until = this.getTime(options.rangeRaw.to, true);\n\n        return `time BETWEEN ${from} AND ${until}`;\n    }\n\n    getTime(date, roundUp) {\n        if (_.isString(date)) {\n            if (date === 'now') return `'now'`;\n\n            let parts = /^now-(\\d+)([d|h|m|s])$/.exec(date);\n            if (parts) {\n                let amount = parseInt(parts[1]);\n                let unit = parts[2];\n\n                return `'now-${amount}${unit}'`;\n            }\n            date = dateMath.parse(date, roundUp);\n        }\n\n        return date.valueOf() + 'ms';\n    }\n\n    buildQueryFronNsgQlStirng(options) {\n        let timeFilter = this.getTimeFilter(options);\n        let queriesList = options.targets.map( (target) => {\n            let query = target.customNsgqlQuery;\n\n            if( query && query.indexOf('$_timeFilter') > 0 ) {\n                query = _.replace(query, '$_timeFilter', timeFilter);\n            }\n\n            return {\n                'nsgql': query,\n                'format': target.format\n            };\n        });\n\n        return queriesList;\n    }\n\n}"]}