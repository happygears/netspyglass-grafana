{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","SQLBuilderFactory","_","NetSpyGlassDatasourceQueryCtrl","$scope","$injector","templateSrv","$q","uiSegmentSrv","prompts","scope","injector","clearSelection","blankDropDownElement","target","category","variable","device","component","sortByEl","selector","aggregator","limit","group","tagFacet","tagOperation","tagWord","tagData","format","formatDisplay","columns","alias","SQLBuilder","queryConfig","factory","console","log","needToBuildQuery","customNsgqlQuery","rowMode","tagSegments","push","newPlusButton","removeTagFilterSegment","newSegment","fake","value","length","refresh","index","splice","query","select","distinct","from","where","orderBy","compile","datasource","executeQuery","then","data","expandable","currentValue","prompt","results","segments","map","segment","text","unshift","html","getVariables","transformToSegments","findDevices","findComponents","findTagFacets","findTagWordsQuery","rawQuery","operation","sortOrder","element","elementDisplayStr","nsgqlQuery","onSelectChange","setDistinct","type","when","nextValue","newOperators","nsgql","addTemplateVars","queryObj","transformToWhereSegments","angular","copy","variables","name","Math","max","newCondition","newOperator","newFake","cssClass","rebuildTargetTagConditions","tags","tagIndex","tagOperator","each","segment2","key","getTagValueOperator","operator","condition","_buildTagsWhere","tagsList","result","forEach","tag","i","obj","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["/*\n * Copyright (c) 2016.  Happy Gears, Inc\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\nimport SQLBuilderFactory from './hg-sql-builder';\nimport _ from \"lodash\";\n\nexport class NetSpyGlassDatasourceQueryCtrl extends QueryCtrl {\n\n    constructor($scope, $injector, templateSrv, $q, uiSegmentSrv) {\n        super($scope, $injector);\n\n        this.prompts = {\n            'category': 'select category',\n            'variable': 'select variable',\n            'device': 'select device',\n            'component': 'select component'\n        };\n\n        this.scope = $scope;\n        this.injector = $injector;\n\n        this.templateSrv = templateSrv;\n        this.$q = $q;\n        this.uiSegmentSrv = uiSegmentSrv;\n\n        this.clearSelection = '-- clear selection --';\n        this.blankDropDownElement = '---';\n        this.target.category = this.target.category || this.prompts['category'];\n        this.target.variable = this.target.variable || this.prompts['variable'];\n        this.target.device = this.target.device || this.prompts['device'];\n        this.target.component = this.target.component || this.prompts['component'];\n        this.target.sortByEl = this.target.sortByEl || 'none';\n        this.target.selector = this.target.selector || ' -- ';\n        this.target.aggregator = this.target.aggregator || ' -- ';\n        this.target.limit = this.target.limit || '100';\n        this.target.group = this.target.group || 'select group';\n        this.target.tagFacet = this.target.tagFacet || this.blankDropDownElement;\n        this.target.tagOperation = this.target.tagOperation || '==';\n        this.target.tagWord = this.target.tagWord || this.blankDropDownElement;\n        this.target.tagData = this.target.tagData || [];\n\n        this.target.format = this.target.format || 'time_series';\n        this.target.formatDisplay = this.target.formatDisplay || 'Time Series';\n\n        this.target.columns = this.target.columns || 'time,variable,device,component,metric';\n        this.target.alias = this.target.alias || '';\n\n\n        // _NEW_\n        this.SQLBuilder = new SQLBuilderFactory();\n        this.target.queryConfig = this.SQLBuilder.factory();\n\n        console.log(this.SQLBuilder);\n        console.log(SQLBuilderFactory.factory);\n\n        //TODO: need to find better way\n        this.target.needToBuildQuery = true;\n        this.target.customNsgqlQuery = \"SELECT time,metric FROM cpuUtil WHERE time BETWEEN 'now-6h' AND 'now'\";\n\n        this.rowMode = false;\n\n        this.category = this.target.category || this.prompts['category'];\n        this.variable = this.target.variable || this.prompts['variable'];\n\n        this.tagSegments = [];\n        this.tagSegments.push(this.uiSegmentSrv.newPlusButton());\n        this.removeTagFilterSegment = uiSegmentSrv.newSegment({fake: true, value: '-- remove tag filter --'});\n    }\n\n    isCategorySelected() {\n        return this.target.category !== this.prompts['category'] && this.target.category !== this.clearSelection;\n    }\n\n    isVariableSelected() {\n        return this.target.variable !== this.prompts['variable'] && this.target.variable !== this.clearSelection;\n    }\n\n    /**\n     * add new tag matching rule that consists of tag facet, operation ('==' or '<>') and tag word.\n     * Unfortunately if input fields for the tag facet and word are blank, the height of the corresponding\n     * visible element is reduced (element <a> is visible and its height is 0 when it has no contents, so\n     * all we see is the margin around it). To work around that I put \"-\" in these fields. It is unobtrusive\n     * enough and looks like some sort of a prompt, but it is a hack nonetheless.\n     * FIXME: find a way to fix height of the visible element without adding any contents.\n     */\n    tagDataAdd() {\n        this.target.tagData[this.target.tagData.length] = {\n            tagFacet : this.blankDropDownElement,\n            tagWord : this.blankDropDownElement,\n            tagOperation : '=='\n        };\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    tagDataRemove(index) {\n        this.target.tagData.splice(index,1);\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    getCategories() {\n        let query = this.SQLBuilder.factory({\n            select: ['category'],\n            distinct: true,\n            from: 'variables',\n            where: ['AND', {\n                category: ['<>', '']\n            }],\n            orderBy: ['category']\n        }).compile();\n\n        return this.datasource.executeQuery(this.SQLBuilder.factory({\n            select: ['category,name'],\n            distinct: true,\n            from: 'variables',\n            where: ['AND', {\n                category: ['<>', '']\n            }],\n            orderBy: ['category']\n        }).compile(), 'json')\n            .then( (data) => {\n                console.log('category,name',data);\n                // this.transformToSegments(this.target.category, this.prompts['category'])\n\n                return [\n                    this.uiSegmentSrv.newSegment({ value: 'test1', expandable: true }),\n                    this.uiSegmentSrv.newSegment({ value: 'test2', expandable: false }),\n                    this.uiSegmentSrv.newSegment({ value: 'test3', expandable: false }),\n                ]\n            });\n\n\n        // return this.datasource.executeQuery(query, 'list')\n        //     .then(this.transformToSegments(this.target.category, this.prompts['category']));\n        // Options have to be transformed by uiSegmentSrv to be usable by metric-segment-model directive\n    }\n\n    transformToSegments(currentValue, prompt) {\n        console.log('transformToSegments called:  currentValue=' + currentValue + ' prompt=' + prompt);\n        return (results) => {\n            var segments = _.map(results, segment => {\n                //TODO: really we need to ckeck segment.text if all request types will be 'list'\n                if( segment.text ) {\n                    return this.uiSegmentSrv.newSegment({ value: segment.text, expandable: segment.expandable });\n                } else {\n                    return this.uiSegmentSrv.newSegment({ value: segment });\n                }\n            });\n            // segments.unshift(this.uiSegmentSrv.newSegment({ fake: true, value: this.clearSelection, html: prompt}));\n\n            // there is no need to add \"clear selection\" item if current value is already equal to prompt\n            if (currentValue !== prompt) {\n                segments.unshift(this.uiSegmentSrv.newSegment({ fake: true, value: this.clearSelection, html: prompt}));\n            }\n\n            return segments;\n        };\n    }\n\n    testRemove() {\n        this.target.variable = this.prompts['variable'];\n        this.getVariables();\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    getVariables() {\n        let query = this.SQLBuilder.factory({\n            select: ['name'],\n            distinct: true,\n            from: 'variables',\n            where: ['AND', {\n                category: ['=', this.target.category]\n            }],\n            orderBy: ['name']\n        }).compile();\n\n        return this.datasource.executeQuery(query, 'list')\n            .then(this.transformToSegments(this.target.variable, this.prompts['variable']));\n        // Options have to be transformed by uiSegmentSrv to be usable by metric-segment-model directive\n    }\n\n    getDevices() {\n        return this.datasource.findDevices(this.target)\n            .then(this.transformToSegments(this.target.device, this.prompts['device']));\n        // Options have to be transformed by uiSegmentSrv to be usable by metric-segment-model directive\n    }\n\n    getComponents() {\n        return this.datasource.findComponents(this.target)\n            .then(this.transformToSegments(this.target.component, this.prompts['component']));\n        // Options have to be transformed by uiSegmentSrv to be usable by metric-segment-model directive\n    }\n\n    getTagsFacet(index) {\n        return this.datasource.findTagFacets(this.target, index)\n            .then(this.transformToSegments(this.target.tagFacet, this.target.tagFacet));  // do not add \"-- clear selection --\" item\n        // Options have to be transformed by uiSegmentSrv to be usable by metric-segment-model directive\n    }\n\n    getTagsWord(index) {\n        return this.datasource.findTagWordsQuery(this.target, index)\n            .then(this.transformToSegments(this.target.tagWord, this.target.tagWord));  // do not add \"-- clear selection --\" item\n    }\n\n    toggleEditorMode() {\n        this.target.rawQuery = !this.target.rawQuery;\n    }\n\n    onChangeInternalCategory() {\n        if (this.target.category == this.clearSelection) {\n            this.target.category = this.prompts['category'];\n        }\n        // user has changed category, we should erase variable and other selections because they are\n        // not valid anymore\n        this.target.variable = this.prompts['variable'];\n        this.target.device = this.prompts['device'];\n        this.target.component = this.prompts['component'];\n        this.target.tagData = [];\n        // TODO: clear variable name when category changes. Only variable name field in the same target should change,\n        // variable name fields in other targets should not change\n        // FIXME: this does not look right, there must be a way to update element in the browser without manipulating it directly in DOM\n        // angular.element('#variable-field').children().children('a').html(this.target.variable);\n        // call refresh to force graph reload (which should turn blank since we dont have enough data\n        // to build valid query)\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    onChangeInternalVariable() {\n        console.log('Variable has changed to ' + this.target.variable);\n        console.log(this);\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    onChangeInternalDevice() {\n        if(this.target.device == this.clearSelection) {\n            this.target.device = this.prompts['device'];\n        }\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n    onChangeInternalComponent() {\n        if(this.target.component == this.clearSelection) {\n            this.target.component = this.prompts['component'];\n        }\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    onChangeInternalTagFacet(index) {\n        // clear tag word when user changes tag facet. The dialog enters state where tag facet is selected\n        // but tag word is not. This state is invalid and should be transient, it does not make sense\n        // to call this.refresh() because query is yet incomplete\n        this.target.tagData[index].tagWord = this.blankDropDownElement;\n        // TODO: clear field \"tag word\" when \"tag facet\" changes. Only associated tag word should change,\n        // tag word fields in another tag matches in the same target or other targets should not change.\n        // FIXME: this does not look right, there must be a way to update element in the browser without manipulating it directly in DOM\n        // angular.element('#tag-word-'+index).children().children(\"a.tag-word\").html(this.target.tagData[index].tagWord);\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    //noinspection JSUnusedLocalSymbols\n    onChangeInternalTagWord(index) {\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    tagOperation(index, operation) {\n        this.target.tagData[index].tagOperation = operation;\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    setSortByEl(sortOrder) {\n        this.target.sortByEl = sortOrder;\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    setSelector(element) {\n        this.target.selector = element;\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    setAggregator(element) {\n        this.target.aggregator = element;\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    setAlias() {\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    setFormat(element, elementDisplayStr) {\n        this.target.format = element;\n        this.target.formatDisplay = elementDisplayStr;\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    setColumns() {\n        // console.log(this.target.columns);\n        this.target.needToBuildQuery = true;\n        this.refresh();\n    }\n\n    // setGroup() {\n    //     if (this.target.group == '') {\n    //         if(this.tempNew !== ''){\n    //             this.target.group = this.tempNew;\n    //         }\n    //         else {\n    //             this.target.group = 'select group';\n    //         }\n    //     }\n    //     this.refresh();\n    // }\n\n\n\n    //////////////////////////////////////////////////\n    //////////////////////////////////////////////////\n    //////////////////_NEW_/////////////////////\n\n\n    onChangeNsgQl() {\n        console.log('onChangeNsgQl');\n\n        console.log(this.target);\n\n        // let nsgql = this.SQLBuilderFactory.factory({\n        //     select: ['id', 'name', 'owner', 'shared'],\n        //     from: 'maps',\n        //     where: [\n        //         'AND',\n        //         {\n        //             id: ['=', id]\n        //         }\n        //     ]\n        // }).compile();\n\n        this.target.nsgqlQuery = [{\n            \"nsgql\": this.target.customNsgqlQuery,\n            \"format\": \"time_series\"\n        }];\n        this.target.needToBuildQuery = false;\n        this.refresh();\n    }\n\n\n    toggleEditorMode() {\n        console.log(11);\n\n        this.rowMode = !this.rowMode;\n    }\n\n    getCollapsedText() {\n        return this.target.customNsgqlQuery;\n    }\n\n    onFromChange() {\n        console.log('%conFromChanges', 'color: blue; font-weight: bold;', this.category);\n\n        if( this.target.category !== this.category  && this.variable != this.prompts['variable']) {\n            console.log(111);\n            this.target.category = this.category;\n            this.variable = this.prompts['variable'];\n            this.onSelectChange();\n            return;\n        }\n\n        this.target.category = this.category;\n\n        console.log('%cqueryConfig', 'color: red; font-weight: bold;', this.target.queryConfig);\n        // console.log('%cquery', 'color: red; font-weight: bold;', this.target.queryConfig.compile());\n        console.log(this.category);\n        this.target.queryConfig.from(this.category);\n    }\n    onSelectChange() {\n        console.log('%conSelectChange', 'color: blue; font-weight: bold;', this.variable);\n\n        this.target.variable = this.variable;\n        this.target.queryConfig.select([this.variable]);\n        this.target.queryConfig.setDistinct(true);\n        // this.panelCtrl.refresh();\n        console.log('%cqueryConfig', 'color: red; font-weight: bold;', this.target.queryConfig);\n        console.log('%cquery', 'color: red; font-weight: bold;', this.target.queryConfig.compile());\n        this.refresh();\n    }\n\n\n\n    getTagsOrValues(segment, index) {\n        console.log(segment, index);\n        let format = 'list';\n\n        if (segment.type === 'condition') {\n            return this.$q.when([this.uiSegmentSrv.newSegment('AND'), this.uiSegmentSrv.newSegment('OR')]);\n        }\n        if (segment.type === 'operator') {\n            var nextValue = this.tagSegments[index+1].value;\n            return this.$q.when(this.uiSegmentSrv.newOperators(['=', '!=', '<>', '<', '>','REGEXP','NOT REGEXP']));\n        }\n\n        let nsgql, addTemplateVars;\n        if (segment.type === 'key' || segment.type === 'plus-button') {\n            nsgql = this.SQLBuilder.factory({\n                select: ['tagFacet'],\n                from: 'devices',\n                orderBy: ['tagFacet']\n            }).compile();\n\n            addTemplateVars = false;\n        } else if (segment.type === 'value')  {\n            let queryObj;\n\n            queryObj = {\n                select: [this.tagSegments[index-2].value],\n                from: 'devices',\n                where: {},\n                orderBy: [this.tagSegments[index-2].value]\n            };\n            queryObj.where[this.tagSegments[index-2].value] = ['NOTNULL'];\n\n            nsgql = this.SQLBuilder.factory(queryObj).compile();\n\n            addTemplateVars = true;\n        }\n\n        return this.datasource.executeQuery(nsgql, format)\n            .then(this.transformToWhereSegments(addTemplateVars))\n            .then(results => {\n                if (segment.type === 'key') {\n                    results.splice(0, 0, angular.copy(this.removeTagFilterSegment));\n                }\n                return results;\n            });\n    }\n\n    transformToWhereSegments(addTemplateVars) {\n        return (results) => {\n            console.log(results);\n            var segments = _.map(results, segment => {\n                return this.uiSegmentSrv.newSegment({ value: `${segment}` });\n            });\n\n            if (addTemplateVars) {\n                for (let variable of this.templateSrv.variables) {\n                    segments.unshift(this.uiSegmentSrv.newSegment({ type: 'template', value: '/^$' + variable.name + '$/', expandable: true }));\n                }\n            }\n\n            return segments;\n        };\n    }\n\n    tagSegmentUpdated(segment, index) {\n        this.tagSegments[index] = segment;\n\n        // handle remove tag condition\n        console.log(this.removeTagFilterSegment.value);\n        console.log(segment);\n        if (segment.value === this.removeTagFilterSegment.value) {\n            this.tagSegments.splice(index, 3);\n            if (this.tagSegments.length === 0) {\n                this.tagSegments.push(this.uiSegmentSrv.newPlusButton());\n            } else if (this.tagSegments.length > 2) {\n                this.tagSegments.splice(Math.max(index-1, 0), 1);\n                if (this.tagSegments[this.tagSegments.length-1].type !== 'plus-button') {\n                    this.tagSegments.push(this.uiSegmentSrv.newPlusButton());\n                }\n            }\n        } else {\n            if (segment.type === 'plus-button') {\n                if (index > 2) {\n                    this.tagSegments.splice(index, 0, this.uiSegmentSrv.newCondition('AND'));\n                }\n                this.tagSegments.push(this.uiSegmentSrv.newOperator('='));\n                this.tagSegments.push(this.uiSegmentSrv.newFake('select tag value', 'value', 'query-segment-value'));\n                segment.type = 'key';\n                segment.cssClass = 'query-segment-key';\n            }\n\n            if ((index+1) === this.tagSegments.length) {\n                this.tagSegments.push(this.uiSegmentSrv.newPlusButton());\n            }\n        }\n\n        this.rebuildTargetTagConditions();\n    }\n\n    rebuildTargetTagConditions() {\n        var tags = [];\n        var tagIndex = 0;\n        var tagOperator = \"\";\n\n        console.log(this.tagSegments);\n\n        _.each(this.tagSegments, (segment2, index) => {\n            if (segment2.type === 'key') {\n                if (tags.length === 0) {\n                    tags.push({});\n                }\n                tags[tagIndex].key = segment2.value;\n            } else if (segment2.type === 'value') {\n                tagOperator = this.getTagValueOperator(segment2.value, tags[tagIndex].operator);\n                if (tagOperator) {\n                    this.tagSegments[index-1] = this.uiSegmentSrv.newOperator(tagOperator);\n                    tags[tagIndex].operator = tagOperator;\n                }\n                tags[tagIndex].value = segment2.value;\n            } else if (segment2.type === 'condition') {\n                tags.push({ condition: segment2.value });\n                tagIndex += 1;\n            } else if (segment2.type === 'operator') {\n                tags[tagIndex].operator = segment2.value;\n            }\n        });\n\n        this.target.tags = tags;\n        console.log(this.target.tags);\n\n        this.target.queryConfig.where( this._buildTagsWhere('tags', this.target.tags) );\n\n\n        console.log('%cqueryConfig', 'color: red; font-weight: bold;', this.target.queryConfig);\n        console.log('%cquery', 'color: red; font-weight: bold;', this.target.queryConfig.compile());\n        // this.refresh();\n    }\n\n    _buildTagsWhere(name, tagsList) {\n        let result = ['AND'];\n\n        if(tagsList.length) {\n            tagsList.forEach( (tag, i) => {\n                let obj = {};\n                obj[tag.key] = [tag.operator, tag.value];\n\n                if(tag.condition) {\n                    result.push(tag.condition);\n                }\n                result.push(obj);\n            })\n        }\n\n        return result;\n    }\n}\n\nNetSpyGlassDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}